app-id: io.github.lkaranl.WaveControl
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: wavecontrol

finish-args:
  # Access to camera/webcam
  - --device=all
  # Access to graphics for GUI
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  # Access to uinput for keyboard simulation
  - --device=all
  # Network access for downloading models (MediaPipe)
  - --share=network
  # Access to home directory for configuration
  - --filesystem=home:ro

modules:
  # Python dependencies
  - name: python3-pip
    buildsystem: simple
    build-commands: []
    sources: []

  # OpenCV
  - name: opencv-python
    buildsystem: simple
    build-commands:
      - pip3 install --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} opencv-python
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/4a/e7/b70a2d9ab205110d715906fc8ec83fbb00404aeb3a371d9b3d616c98450b3/opencv_python-4.10.0.84-cp37-abi3-manylinux2014_x86_64.manylinux_2_17_x86_64.whl
        sha256: 1a47e2ac8aca55876021c43b6526265ab1bb0b87a91b6b5b4e4c0cc8d0b5dc3d

  # NumPy
  - name: numpy
    buildsystem: simple
    build-commands:
      - pip3 install --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} numpy
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/65/6e/09db70a523a96d25e115e71cc56a6f9031e7b9cd9376aa0f379a5d4223307/numpy-1.24.4-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
        sha256: 80f5e3a4e498641401868df4208b74581206afbee7cf7b8329daae82676d9463

  # MediaPipe
  - name: mediapipe
    buildsystem: simple
    build-commands:
      - pip3 install --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} mediapipe
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/95/42/5e63cb2e93d8dd82ce2624d97fd9cd607c0655a3b6b39f7c6b0a6bea46fce/mediapipe-0.10.14-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
        sha256: 3ba5497d9eb5b5df53c4b9062f5ad05b1b06b8a59e885c71b3e5b5a00132b451

  # python-uinput 
  - name: python-uinput
    buildsystem: simple
    build-commands:
      - pip3 install --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} python-uinput
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/89/5b/57b7ccdf86ac0b1fb43d5b8b7b5d4b81e66c80fd1c0bc43d3d8d5b0e1a5c3/python_uinput-1.0.1-cp310-cp310-linux_x86_64.whl
        sha256: 234a2a29393b6b25e1b0e18b5bacd30a1f7a8bdbc89ceeb0e6e45c3b2a5b9fc2

  # WaveControl application
  - name: wavecontrol
    buildsystem: simple
    build-commands:
      # Install the main application
      - install -Dm755 main.py ${FLATPAK_DEST}/bin/wavecontrol-main.py
      # Create wrapper script
      - |
        cat > ${FLATPAK_DEST}/bin/wavecontrol << 'EOF'
        #!/bin/bash
        exec python3 ${FLATPAK_DEST}/bin/wavecontrol-main.py "$@"
        EOF
      - chmod +x ${FLATPAK_DEST}/bin/wavecontrol
      # Install desktop file
      - install -Dm644 io.github.lkaranl.WaveControl.desktop ${FLATPAK_DEST}/share/applications/io.github.lkaranl.WaveControl.desktop
      # Install icon
      - install -Dm644 icon.png ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/io.github.lkaranl.WaveControl.png
      # Install AppStream metadata
      - install -Dm644 io.github.lkaranl.WaveControl.metainfo.xml ${FLATPAK_DEST}/share/metainfo/io.github.lkaranl.WaveControl.metainfo.xml
    sources:
      - type: file
        path: ../main.py
      - type: file
        path: io.github.lkaranl.WaveControl.desktop
      - type: file
        path: icon.png
      - type: file
        path: io.github.lkaranl.WaveControl.metainfo.xml
